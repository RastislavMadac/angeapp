<app-navbar></app-navbar>
<app-small-navbar></app-small-navbar>

<app-master-layout
  [masterTemplateInput]="masterTpl"
  [detailTemplateInput]="detailTpl"
  [items]="items">
</app-master-layout>

<ng-template #masterTpl>
  <app-generic-table 
    [columns]="columns" 
    [data]="(filteredData$ | async) ?? []"
    (rowClick)="selectItem($event)">
  </app-generic-table>
</ng-template>

<ng-template #detailTpl>
  <div class="qc-main-layout" [class.centered-mode]="selectedItem?.id" *ngIf="inspectionForm">
    
    <div class="qc-form-side">
      <div class="qc-container">
        
        <div class="top-actions">
          <button mat-raised-button color="primary" (click)="createNewCheck()">
            <mat-icon>add</mat-icon> Nová kontrola
          </button>
        </div>

        <header class="qc-header">
          <div class="qc-title">
            <span *ngIf="selectedItem?.id">S/N: #{{ selectedItem?.instance_serial_number }}</span>
            <h2>{{ selectedItem?.id ? selectedItem?.product_name : 'Nová kontrola tovaru' }}</h2>
          </div>
          <div class="status-badge" *ngIf="selectedItem?.id" [class.badge-error]="inspectionForm.get('defect_status')?.value === 'error'">
            {{ inspectionForm.get('defect_status')?.value | uppercase }}
          </div>
        </header>

        <div class="locked-info" *ngIf="isLocked">
          <mat-icon>lock</mat-icon> Táto kontrola je uzavretá a nie je možné ju editovať.
        </div>

        <form [formGroup]="inspectionForm" (ngSubmit)="saveCheck()">
          
          <div class="create-mode-box" *ngIf="!selectedItem?.id">
            
            <div class="form-field">
              <label>Skenovať kód (EAN / SKU) *</label>
              <div class="input-with-action">
                <input type="text" 
                       class="qc-input" 
                       placeholder="Naskenujte kód produktu..." 
                       (input)="onProductCodeInput($event)">
                       
                <button type="button" class="btn-dots" (click)="openProductLookup()" matTooltip="Vyhľadať v zozname">
                  <mat-icon>list</mat-icon>
                </button>
              </div>
            </div>
          
            <div class="form-field">
              <label>Identifikovaný produkt</label>
              <input type="hidden" formControlName="product_id">
          
              <div class="product-display-box" [class.has-product]="foundProductName && foundProductName !== 'Produkt nenájdený' && foundProductName !== 'Hľadám...'">
                <mat-icon *ngIf="foundProductName && foundProductName !== 'Produkt nenájdený' && foundProductName !== 'Hľadám...'">
                  check_circle
                </mat-icon>
                <span class="product-name-text">
                  {{ foundProductName || 'Čakám na kód...' }}
                </span>
                <mat-spinner *ngIf="foundProductName === 'Hľadám...'" diameter="20"></mat-spinner>
              </div>
            </div>

            <div class="form-field">
              <label>Sériové číslo kusu *</label>
              <div class="input-with-action">
                <input type="text" 
                       formControlName="serial_number" 
                       class="qc-input" 
                       [class.sn-exists]="isSnUnique === false"
                       [class.sn-ok]="isSnUnique === true"
                       placeholder="Zadajte S/N kusu"
                       (input)="onSnInput($event)">
                
                <div class="sn-status-icon" *ngIf="isSnUnique !== null">
                  <mat-icon *ngIf="isSnUnique === true" class="text-success">check_circle</mat-icon>
                  <mat-icon *ngIf="isSnUnique === false" class="text-error" matTooltip="Toto S/N už existuje!">cancel</mat-icon>
                </div>
              </div>
              
              <p class="error-msg-sn" *ngIf="isSnUnique === false">
                <mat-icon>warning</mat-icon> Pozor: Tento kus už bol v minulosti skontrolovaný!
              </p>
            </div>

            <div class="form-field">
              <label>Dátum výroby *</label>
              <input type="date" formControlName="manufacture_date" class="qc-input">
            </div>

            <div class="form-field">
              <label>Vyrobil (Technik) *</label>
              <select formControlName="manufactured_by" class="qc-input">
                <option [ngValue]="null" disabled>Vyberte...</option>
                <option *ngFor="let user of users" [ngValue]="user.id">
                  {{ user.first_name }} {{ user.last_name }}
                </option>
              </select>
            </div>
          </div> 
          <div class="check-grid">
            <div class="check-card" 
                 [class.active-ok]="inspectionForm.get('visual_check')?.value === true"
                 [class.not-checked]="inspectionForm.get('visual_check')?.value === false"
                 (click)="isLocked ? null : inspectionForm.patchValue({visual_check: !inspectionForm.get('visual_check')?.value})">
              
              <mat-icon>{{ inspectionForm.get('visual_check')?.value ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
              <strong>Vizuálna kontrola</strong>
              
              <span class="status-label">
                {{ inspectionForm.get('visual_check')?.value ? 'Skontrolované' : 'Neskontrolované' }}
              </span>
            </div>
          
            <div class="check-card" 
                 [class.active-ok]="inspectionForm.get('packaging_check')?.value === true"
                 [class.not-checked]="inspectionForm.get('packaging_check')?.value === false"
                 (click)="isLocked ? null : inspectionForm.patchValue({packaging_check: !inspectionForm.get('packaging_check')?.value})">
              
              <mat-icon>{{ inspectionForm.get('packaging_check')?.value ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
              <strong>Balenie</strong>
              
              <span class="status-label">
                {{ inspectionForm.get('packaging_check')?.value ? 'Skontrolované' : 'Neskontrolované' }}
              </span>
            </div>
          </div>

          <div class="status-selector">
            <button type="button" 
                    class="status-btn ok" 
                    [class.active]="inspectionForm.get('defect_status')?.value === 'ok'"
                    [disabled]="isLocked"
                    (click)="isLocked ? null : inspectionForm.patchValue({defect_status: 'ok'})">
              OK
            </button>
            
            <button type="button" 
                    class="status-btn error" 
                    [class.active]="inspectionForm.get('defect_status')?.value === 'error'"
                    [disabled]="isLocked"
                    (click)="isLocked ? null : inspectionForm.patchValue({defect_status: 'error'})">
              CHYBA
            </button>
          </div>
          
          <small class="error-text" *ngIf="inspectionForm.get('defect_status')?.value === 'none' && inspectionForm.touched">
            Prosím, vyberte výsledný stav kontroly.
          </small>
          <div class="form-field">
            <label>Poznámka technika</label>
            <textarea formControlName="defect_description" class="qc-textarea" rows="3" placeholder="Zadajte zistenia..."></textarea>
          </div>

          <div class="shipping-box">
            <span>Schváliť na expedíciu?</span>
            <input type="checkbox" formControlName="approved_for_shipping">
          </div>

          <div class="qc-actions" *ngIf="!isLocked">
            <button class="btn-primary" type="submit" [disabled]="inspectionForm.invalid || isLoading">
              {{ selectedItem?.id ? 'Uložiť zmeny' : 'Vytvoriť kontrolu' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="qc-photos-side" *ngIf="!selectedItem?.id">
      <div class="photo-header">
        <h3><mat-icon>collections</mat-icon> Fotodokumentácia</h3>
      </div>
      <div class="photo-gallery">
        <div class="photo-item empty">
          <span>Tu sa zobrazia vzorové fotografie k produktu</span>
        </div>
      </div>
    </div>

  </div>
</ng-template>