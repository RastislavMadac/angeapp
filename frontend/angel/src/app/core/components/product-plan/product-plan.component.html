<!-- Navbar -->
<app-navbar [selectedItem]="selectedItem"></app-navbar>

<!-- Small navigation menu -->
<app-small-navbar ></app-small-navbar>



<!-- üîπ DETAIL TEMPLATE -->
<ng-template #detailTpl>
  <form [formGroup]="itemForm" *ngIf="itemForm" class="product-grid" 
      >

    <!-- üî∏ Sekcia: z√°kladn√© info o pl√°ne -->
    <div class="plan-header" >
      <label>ƒå√≠slo pl√°nu:
        <input formControlName="plan_number">
      </label>
      
      <label>Platn√Ω od:
        <input type="date" formControlName="start_date">
      </label>
      <label>Platn√Ω do:
        <input type="date" formControlName="end_date">
      </label>
    </div>

    <hr />
  

    <!-- üîπ Sekcia: produkty -->
    <div formArrayName="items"class="products-section">
      <div *ngFor="let itemGroup of itemsFormArray.controls; let i = index" 
      [formGroupName]="i" 
      class="product-item"
      (click)="selectItemForDelete(i)" 
      [class.is-selected]="selectedItemIndex === i"
      [ngClass]="getItemStatusClass(i)">

        <!-- Produkt info -->
        <h3>
          {{ itemGroup.get('product_name')?.value }} 
          
          <span *ngIf="itemGroup.get('product_id')?.value">({{ itemGroup.get('product_id')?.value }})</span>
      </h3>

        <div class="product-fields">
          <label>ID:
            <input formControlName="id" readonly>
          </label>
        

          
          
          <label class="product-input-group">
            K√≥d produktu:
            <div class="input-with-button">
              <input 
                formControlName="product_id" 
                placeholder="Zadajte jedineƒçn√Ω k√≥d produktu..."
                type="text"
                autocomplete="off"
              >
              <button 
    type="button" 
    class="lookup-button"
    (click)="openModalForEdit(i)" title="Vyhƒæada≈• produkt..."
>
    &#8942;
</button>
            </div>
          </label>
                   
          <label>Pl√°novan√© mno≈æstvo:
            <input type="number" formControlName="planned_quantity" min="1">
          </label>
          <label>D√°tum v√Ωroby:
            <input type="date" formControlName="planned_date">
          </label>
          <label>Status:
            <select formControlName="status">
              
              <option value="pending" *ngIf="itemGroup.get('status')?.value === 'pending'">
                ƒåak√° sa
              </option>
      
              <option value="in_production" *ngIf="itemGroup.get('status')?.value === 'in_production'">
                Vo v√Ωrobe
              </option>
      
              <option value="partially completed" *ngIf="itemGroup.get('status')?.value === 'partially completed'">
                ƒåiastoƒçne prenesen√°
              </option>
      
              <option value="completed" *ngIf="itemGroup.get('status')?.value === 'completed'">
                Dokonƒçen√©
              </option>
      
              <option value="canceled">
                Zru≈°en√©
              </option>
      
            </select>
          </label>
          <label>Prenesen√© mno≈æstvo:
            <input formControlName="transfered_pcs" readonly>
          </label>
        </div>

        <!-- Dropdown button pre ingrediencie -->
        <button type="button" class="btn-dropdown" (click)="toggleIngredients(i)">
          Ingrediencie {{ isExpanded[i] ? '‚ñ≤' : '‚ñº' }}
        </button>

        <!-- Dropdown obsah ingredienci√≠ -->
        <div *ngIf="isExpanded[i]" formArrayName="ingredients_status" class="ingredients-table-wrapper">
          <table class="ingredients-table">
            <thead>
              <tr>
                <th>N√°zov ingrediencie</th>
                <th>Po≈æadovan√© mno≈æstvo</th>
                <th>Dostupn√© mno≈æstvo</th>
                <th>Dostatok</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let ing of getIngredientsFormArray(itemGroup).controls; let j = index" [formGroupName]="j">
                <td>{{ ing.get('ingredient')?.value }}</td>
                <td>{{ ing.get('required_qty')?.value }}</td>
                <td>{{ ing.get('available_qty')?.value }}</td>
                <td>
                  <span [ngClass]="{
                      'sufficient': ing.get('is_sufficient')?.value,
                      'insufficient': !ing.get('is_sufficient')?.value
                    }">
                    {{ ing.get('is_sufficient')?.value ? '‚úîÔ∏è √Åno' : '‚ùå Nie' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <div class="form-actions">
      <button 
      type="button" 
      class="btn-save"
      matTooltip="Ulo≈æ√≠ aktu√°lne zmeny pl√°nu"
      (click)="!suppressLiveSave && !isCreatingNewPlan && saveItem()"
      >
      üíæ Ulo≈æi≈• zmeny
    </button>

      <button type="button" class="btn-cancel" (click)="cancelEdit()"
      matTooltip="Zma≈æe aktu√°lne vybran√∫ polo≈æku pl√°nu">‚ùå Zru≈°i≈•</button>
      
      <button 
    type="button" 
    class="btn-add" 
    (click)="addNewItem()" 
    matTooltip="Prid√° nov√∫ polo≈æku produktu do pl√°nu."
  >
    ‚ûï Prida≈• polo≈æku
  </button>

      <button 
        type="button" 
        class="btn-delete" 
        (click)="deleteItem()" 
        [disabled]="selectedItemIndex === null"
        matTooltip="Zma≈æe aktu√°lne vybran√∫ polo≈æku pl√°nu"
      >
        üóëÔ∏è Vymaza≈• polo≈æku
      </button>

      <button (click)="createNewPlan()" class="btn btn-primary">
        <i class="fas fa-plus"></i> üß©Vytvori≈• Nov√Ω Pl√°n
    </button>
    </div>

  </form>
</ng-template>

<!-- Spinner -->
<div class="spinner-wrapper" *ngIf="isLoading">
  <mat-progress-spinner
    mode="indeterminate"
    color="primary"
    diameter="50">
  </mat-progress-spinner>
  <p>Naƒç√≠tavam d√°ta...</p>
</div>

<!-- Error message -->
<div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>


<!-- üîπ MASTER LAYOUT -->
<app-master-layout
   [masterTemplateInput]="masterTpl" 
   [detailTemplateInput]="detailTpl"
   [items]="objectItems"
   [(selectedItem)]="selectedItem"
   (select)="selectItems($event)">
</app-master-layout>

<!-- üîπ MASTER TEMPLATE -->
<ng-template #masterTpl>
  <ng-container *ngIf="objectItems.length">
  <app-generic-table
    [columns]="columns"
    [data]="objectItems"
    [selectedItem]="selectedItem"
    (rowClick)="selectItems($event)"
    [rowClassMap]="rowClasses"
    [defaultSortColumn]="'plan_number'"
   >
  </app-generic-table>
</ng-container>
</ng-template>



